{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout Personalizado</title>
    <link rel="stylesheet" href="{% static 'checkout/css/index.css' %}" />

    <!-- Animación para el spinner de carga -->
    <style>
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>

    <script src="https://sandbox-checkout.izipay.pe/payments/v1/js/index.js?mode=embedded&container=iframe-payment-form"></script>
  </head>
  <body>
    <div class="header-section">
      <div class="header-image"></div>
    </div>

    <div class="main-container">
      <!-- Sección izquierda: formulario -->
      <div class="left-section">
        <form id="checkout-form" method="POST">
          {% csrf_token %}
          <div class="section-title">Cuenta</div>
          <div class="form-group">
            <input
              type="email"
              name="email"
              placeholder="Correo electrónico"
              required
            />
          </div>

          <div class="section-title">Entrega</div>
          <div class="form-row">
            <div class="form-group">
              <input
                type="text"
                name="first_name"
                placeholder="Nombre"
                required
              />
            </div>
            <div class="form-group">
              <input
                type="text"
                name="last_name"
                placeholder="Apellido"
                required
              />
            </div>
          </div>
          <div class="form-group">
            <input
              type="text"
              name="address1"
              placeholder="Dirección"
              required
            />
          </div>
          <div class="form-group">
            <input
              type="text"
              name="address2"
              placeholder="Apartamento, suite, etc. (opcional)"
            />
          </div>
          <div class="form-row">
            <div class="form-group">
              <input type="text" name="city" placeholder="Ciudad" required />
            </div>
            <div class="form-group">
              <select name="province" required>
                <option value="">Seleccionar región</option>
                <option value="lima">Lima</option>
                <option value="arequipa">Arequipa</option>
                <option value="cusco">Cusco</option>
              </select>
            </div>
            <div class="form-group">
              <input
                type="text"
                name="zip"
                placeholder="Código postal"
                required
              />
            </div>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="save-info" />
            <label for="save-info"
              >Guardar esta información para la próxima vez</label
            >
          </div>

          <div class="section-title">Método de envío</div>
          <div class="delivery-options">
            <div class="delivery-option selected">
              <input
                type="radio"
                name="shipping_method"
                value="pickup"
                checked
              />
              <div class="delivery-info">
                <div class="delivery-title">Retiro en tienda</div>
              </div>
              <div class="delivery-price">GRATIS</div>
            </div>
          </div>

          <div class="section-title">Pago</div>
          <div class="payment-methods">
            <div class="payment-method">
              <input type="radio" name="payment" value="card" checked />
              <label>Pago seguro con tarjeta, efectivo y transferencia</label>
            </div>
          </div>

          <!-- Contenedor para el formulario embebido de Izipay -->
          <div
            id="izipay-form-container"
            style="
              min-height: 400px;
              width: 100%;
              border: 1px solid #e0e0e0;
              border-radius: 8px;
              padding: 20px;
              background: #fff;
            "
          >
            <div style="text-align: center; color: #666; padding: 40px">
              <p>Cargando formulario de pago...</p>
              <div
                style="
                  display: inline-block;
                  width: 20px;
                  height: 20px;
                  border: 3px solid #f3f3f3;
                  border-top: 3px solid #00a09d;
                  border-radius: 50%;
                  animation: spin 1s linear infinite;
                "
              ></div>
            </div>
          </div>

          <button type="submit" class="continue-button">
            Completar pedido
          </button>
        </form>
      </div>

      <!-- Sección derecha: resumen del pedido -->
      <div class="right-section">
        <div class="order-summary" id="cart"></div>

        <div class="discount-code">
          <input
            type="text"
            class="discount-input"
            placeholder="Código de descuento"
          />
          <button type="button" class="discount-button">Aplicar</button>
        </div>

        <div class="order-totals">
          <div class="total-line">
            <span>Subtotal</span><span id="subtotal">S/ 0.00</span>
          </div>
          <div class="total-line">
            <span>Envío</span><span id="shipping-cost">GRATIS</span>
          </div>
          <div class="total-line final">
            <span>Total</span><span id="total">PEN S/ 0.00</span>
          </div>
        </div>
      </div>
    </div>
    <!-- Contenedor para el formulario de Izipay -->
    <div
      id="your-iframe-payment"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        display: none;
      "
    >
      <div
        style="
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 20px;
          border-radius: 8px;
          max-width: 500px;
          width: 90%;
        "
      >
        <h3>Procesando pago...</h3>
        <div id="payment-processing-container"></div>
      </div>
    </div>

    <!-- Scripts separados -->
    <script src="{% static 'checkout/js/shopify-handler.js' %}"></script>
    <script src="{% static 'checkout/js/izipay-handler.js' %}"></script>
    <script src="{% static 'checkout/js/ui-manager.js' %}"></script>
    <script src="{% static 'checkout/js/checkout-controller.js' %}"></script>

    <!-- Script de inicialización -->
    <script>
      window.addEventListener("load", () => {
        if (typeof Izipay !== "undefined") {
          console.log("✅ SDK de Izipay cargado correctamente");
        } else {
          console.error("❌ SDK de Izipay no se pudo cargar");
        }
      });

      // Inicializar CheckoutController
      const checkoutController = new CheckoutController();
    </script>
  </body>
</html>
